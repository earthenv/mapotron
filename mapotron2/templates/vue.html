<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{collection.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0px;}
      #map { width: 100%; height: 100%;}
      #toastPlacement {
        position: absolute;
        top: 0px;
        left: 0;
      }
      #toastPlacementRight {
        position: absolute;
        top: 0px;
        right: 50px;
      }
      .toast-header {
        padding: 0.6rem .75rem;
      }
      #layer-toast > .toast-body {
        max-height: 80vh;
        overflow-y: scroll;
      }
      .layer-toast > .toast-body {
        max-height: 80vh;
        overflow-y: scroll;
      }

      .active-layer {
        font-weight: 500;
        font-size: 18px;
      }
      .non-active-layer {
        font-weight: 200;
        font-size: 12px;
      }
      .layer-control {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 5px 0;
        width: 100%;
      }
      .layer-control > span {
        min-width: 60%;
        cursor: pointer;
      }
      .layer-control > .slide {
        min-width: 40%;
      }
      #sample-spinner {
        /* margin: 5px; */
        margin-left: 10px;
        height: 20px;
        width: 20px;
      }
      #layer-spinner {
        height: 20px;
        width: 20px;
      }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-slider-component@latest/theme/default.css">


</head>
<body>
  <div id="map"></div>
    <div id="root">
      <div>
        <div class="toast-container position-absolute p-2" id="toastPlacement">
          <div id="layer-toast" class="toast">
            <div class="toast-header">
              <strong class="me-auto">{{collection.title}}</strong>
              <!-- <small>11 mins ago</small> -->
              <div v-if="layerLoading" id="layer-spinner" class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div class="toast-body">
              <div v-for="layer in layers" :class="{ 'active-layer': layer.show, 'not-layer': !layer.show, 'layer-control': true }">
                <span v-on:click="toggleLayer(layer)">{{"layer.title"|vue}}</span>
                <vue-slider
                  class="slide"
                  tooltip="none"
                  :min="0"
                  :max="1"
                  :interval="0.01"
                  v-model="layer.opacity"
                  v-on:change="updateOpacity(layer)"
                ></vue-slider>
              </div>
            </div>
          </div>
        </div>
        <div class="toast-container position-absolute p-2" id="toastPlacementRight">
          <div id="layer-toast" class="toast">
            <div class="toast-header">
              <strong class="me-auto">Sample</strong>
              <small v-if="lat && lng">Lng: {{"lng.toFixed(3)"|vue}}, Lat: {{"lat.toFixed(3)"|vue}}</small>
              <small v-if="!(lat && lng)">Click on the map to get values at that point</small>
              <button v-if="lat && lng && !sampleLoading" type="button" class="btn-close" v-on:click="clearSample" aria-label="Close"></button>
              <div v-if="sampleLoading" id="sample-spinner" class="spinner-border text-primary " role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div class="toast-body" v-if="Object.keys(sampleData).length > 0">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Layer</th>
                    <th scope="col">Value</th>
                    <!-- <th scope="col">Unit</th> -->
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="layer,val in sampleData">
                    <th scope="row">{{"layer[0]['title']" | vue }}</th>
                    <td scope="row">{{"layer[0]['values']['b1']" | vue }}</td>
                    <!-- <td scope="row">{{"layer[0]['units']" | vue }}</td> -->
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key={{config.GMAPS_KEY}}"></script>
    <!-- make it non min vue for development -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.0/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-slider-component@latest/dist/vue-slider-component.umd.min.js"></script>
    <script src="/static/ee_api_js.js"></script>
    <script src="/static/mapstyles.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script>
      const EE_MAP_PATH = 'https://earthengine.googleapis.com/v1alpha';
      const DEFAULT_OPACITY = 0.65;
      document.addEventListener('DOMContentLoaded', function() {
        var getTileSource = function(mapid= '{{map.mapid}}', token = '{{map.token}}') {
          return new ee.layers.EarthEngineTileSource({
              mapid,
              token,
              formatTileUrl: (x, y, z) =>
                `${EE_MAP_PATH}/${mapid}/tiles/${z}/${x}/${y}`
            })
        }
        Vue.component('vueSlider', window[ 'vue-slider-component' ]);
  
        new Vue({
          el: '#root',
          mounted: function() {
            const myLatLng = new google.maps.LatLng(0, 0);
            const urlParams = new URLSearchParams(window.location.search);
            const embed = urlParams.get('embed');
            const basemap = urlParams.get('basemap');
            const mapOptions = {
              scrollwheel: (embed !== 'true'),
              streetViewControl: false,
              panControl: false,
              maxZoom: 18,
              minZoom: 1,
              center: myLatLng,
              zoom: 3,
              styles: styles,
              rotateControl: true,
              mapTypeId: (basemap==='earth') ? google.maps.MapTypeId.SATELLITE : google.maps.MapTypeId.ROADMAP,
              rotateControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT

              },
              fullscreenControl: true,
              fullscreenControlOptions: {
                position: google.maps.ControlPosition.TOP_RIGHT

              },
              mapTypeControl: true,
              mapTypeControlOptions: {
                position: google.maps.ControlPosition.TOP_CENTER,
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR

              },
              zoomControl: true,
              zoomControlOptions: {
                style: google.maps.ZoomControlStyle.LARGE,
                position: google.maps.ControlPosition.RIGHT_TOP
              }
            };
            this.map = new google.maps.Map(document.getElementById('map'), mapOptions);
            this.$nextTick(() => {
              let layer = this.layers.find(x => x.layer_id === this.selectedLayer);
              layer.mapLayer = new ee.layers.ImageOverlay(getTileSource());
              layer.visible = layer.show;
              layer.mapLayer.setOpacity(DEFAULT_OPACITY);
              layer.mapIndex = this.map.overlayMapTypes.length;
              this.map.overlayMapTypes.push(layer.mapLayer);
            })
            google.maps.event.addListener(this.map, 'click', (event) => {
                this.lat = event.latLng.lat()
                this.lng = event.latLng.lng()
                this.sampleLoading = true;
                this.sampleData = false;
                if (this.marker) {
                  this.marker.setMap(null);
                }
                this.marker = new google.maps.Marker({
                    position: event.latLng
                });
                this.marker.setMap(this.map);

                // To add the marker to the map, call setMap();
                this.marker.setMap(this.map);
                axios.get(`/sample/{{collection_id}}/${this.lng}/${this.lat}`)
                  .then((response) => {
                    this.sampleData = response.data;
                    this.sampleLoading = false;
                    console.log('sampleData:', this.sampleData)
                  })
            });
          },
          methods: {
            toggleLayer(layer) {
              // the layer has been initialized
              if (layer.mapLayer) {
                if (layer.show) {
                  // remove the layer from the map
                  this.map.overlayMapTypes.removeAt(layer.mapIndex);
                } else {
                  layer.mapIndex = this.map.overlayMapTypes.length;
                  this.map.overlayMapTypes.push(layer.mapLayer);
                }
                layer.show = !layer.show;
              } else {
                this.layerLoading = true;
                axios.get(`/map/{{collection_id}}/${layer.layer_id}`).then(response => {
                  this.layerLoading = false;
                  var m = response.data.map
                  layer.mapLayer = new ee.layers.ImageOverlay(getTileSource(m.mapid, m.token));
                  layer.show = true;
                  layer.mapLayer.setOpacity(DEFAULT_OPACITY);
                  layer.mapIndex = this.map.overlayMapTypes.length;
                  this.map.overlayMapTypes.push(layer.mapLayer);
                })
              }
            },
            updateOpacity(layer) {
              if (layer.mapLayer) {
                layer.mapLayer.setOpacity(layer.opacity);
              }
            },
            clearSample() {
              this.lat = null;
              this.lng = null;
              this.sampleData = {};
              this.marker.setMap(null);
            }
          },
          watch: {
            // value: function (val) {
            //   this.layer.setOpacity(val/100)
            // }
          },
          data: function () {
            var collection = JSON.parse('{{ collection | tojson }}')
            var layers =  Object.values(collection.layers)
            layers.sort(x => - x.index)
            var selectedLayer = '{{layer_id}}'
            layers.forEach((layer, i) => {
              layer.gmapsLayer = null;
              layer.selected = layer.layer_id === selectedLayer;
              layer.opacity = DEFAULT_OPACITY;
            })
            return {
              place: '',
              layers: layers,
              selectedLayer,
              map: null,
              lat: null, 
              lng: null,
              title: collection.title, 
              sampleData: {},
              sampleLoading: false,
              layerLoading: false,
              marker: null
            }
          },
        });

        // init the toasts
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
          return new bootstrap.Toast(toastEl, {autohide: false})
        })
        toastList.forEach(t => t.show())
        // $('.toast').toast('show', {autohide: false})
      });
      

    </script>

  
  </body>
</html>